import{__spreadArrays as e,__assign as t}from"tslib";import r,{useMemo as n,useRef as o,useCallback as i,useEffect as a}from"react";import{Line as u,Area as l,LinePath as c}from"@visx/shape";import{scaleOrdinal as s}from"@visx/scale";import{curveMonotoneX as m}from"@visx/curve";import{useRecoilValue as f,useSetRecoilState as d}from"recoil";import{themeState as p,layoutState as y,TooltipContainer as g,tooltipState as h,XTooltip as v,YTooltip as x,aesState as k,dataState as E,scalesState as O,EventField as S}from"@graphique/gg";import"d3-time-format";import{schemeTableau10 as _}from"d3-scale-chromatic";import b from"loess";import{regressionLinear as w}from"d3-regression";import{extent as N,mean as F,sum as A,min as M,max as z}from"d3-array";import{studentt as B}from"jstat";var D=e([_[0],_[1],_[4],_[2],_[3]],_.slice(5)),R=function(e){var t=e.left,n=e.y,o=e.lineVals,i=e.markerFill,a=e.markerRadius,l=e.strokeOpacity,c=f(p).markerStroke,s=f(y),m=s.height,d=s.margin;return r.createElement(r.Fragment,null,r.createElement("g",null,r.createElement(u,{from:{x:t,y:0},to:{x:t,y:m-d.top-d.bottom},stroke:"#888",strokeWidth:1.5,style:{pointerEvents:"none"},strokeDasharray:"2,2"})),o.map((function(e){var o=e.group,u=e.isOutsideBounds,s=e.y;return o&&!u?r.createElement("g",{key:"linemarker-"+o},r.createElement("circle",{cx:t,cy:n({y:s}),r:a,fill:i(o),fillOpacity:l||.9,stroke:c,strokeOpacity:.92,strokeWidth:a/3.2,style:{pointerEvents:"none"}})):null})))},T=function(e){var t=e.data,n=e.hasXAxisTooltip,o=void 0!==n&&n,i=t[0].formattedX;return t&&r.createElement(g,null,!o&&r.createElement("div",{style:{marginTop:2,marginBottom:1===t.length?2:6,color:"#555"}},i),t.map((function(e,n){return r.createElement("div",{key:"group-tooltip-"+(e.label||e.group)},r.createElement("div",{style:{marginTop:3,marginBottom:t.length<n+1?3:2,display:"flex",alignItems:"center"}},(e.label||"__group"!==e.group)&&r.createElement(r.Fragment,null,e.mark,r.createElement("div",{style:{display:"flex",alignItems:"flex-end",marginLeft:4}},r.createElement("div",{style:{marginRight:5}},r.createElement("span",null,e.label||e.group," ")))),r.createElement("div",{style:{fontWeight:500,fontSize:13}},e.formattedY)))})))},W=function(e){var t=e.data,o=e.method,i=e.x,a=e.y,l=e.b,c=e.markerRadius,s=e.strokeOpacity,m=e.fillOpacity,d=e.thisStrokeScale,p=e.thisSizeScale,k=e.thisDashArrayScale,E=e.stroke,O=e.size,S=e.dashArray,_=e.models,b=f(h),w=b.x0,A=b.content,M=b.xAxis,z=b.position,B=b.yFormat,D=b.xFormat,W=f(y),q=W.height,X=W.id,j=W.margin,I=n((function(){return N(t,l)}),[t,l]),V=n((function(){return+w<I[0]||+w>I[1]}),[w,I]),Y=n((function(){return w&&_.map((function(e){var t=N(e.model.x[0]),n=+w<t[0]||+w>t[1],a="loess"===o?e.model.predict({x:[+w]}).fitted[0]:e.model.predict(+w),l=r.createElement("svg",{height:20,width:20},r.createElement("rect",{width:20,height:20,fill:d(e.group),fillOpacity:m}),r.createElement(u,{from:{x:0,y:10},to:{x:24,y:10},stroke:d(e.group),strokeWidth:p(e.group),strokeDasharray:k(e.group)}));return{group:e.group,mark:l,x:i({x:w}),y:a,formattedY:B?B(a):a,formattedX:D?D(w):w.toString(),isOutsideBounds:n}})).filter((function(e){return!e.isOutsideBounds}))}),[_,i,w,S,m,O,d,p,d,B,o]),G=n((function(){return Y&&F(Y.filter((function(e){return!e.isOutsideBounds})).map((function(e){return a({y:e.y})})))}),[Y,a]);return w&&!V?r.createElement(r.Fragment,null,r.createElement(R,{left:i({x:w}),y:a,markerRadius:c,markerFill:function(e){return"__group"===e?E:d(e)},strokeOpacity:s,lineVals:Y}),M&&r.createElement(v,{id:X,left:i({x:w}),top:-j.bottom-5,value:"boolean"==typeof M?r.createElement(g,null,D?D(w):w.toString()):M({x:w})}),Y&&Y.length&&r.createElement(x,{id:X,left:i({x:+w}),top:"data"===z&&G?-(q-G):-q,value:A?A({data:Y}):r.createElement(T,{data:Y,hasXAxisTooltip:!!M})})):null},q=function(e){var u=e.stroke,y=e.strokeOpacity,g=void 0===y?1:y,h=e.strokeDashArray,v=e.size,x=void 0===v?2.5:v,_=e.scales,N=e.se,R=void 0!==N&&N,T=e.fill,q=e.fillOpacity,X=void 0===q?.2:q,j=e.method,I=void 0===j?"loess":j,V=e.span,Y=void 0===V?.75:V,G=e.band,L=void 0===G?.8:G,U=e.bins,C=void 0===U?80:U,H=e.level,J=void 0===H?.95:H,K=e.hideTooltip,P=void 0!==K&&K,Q=e.markerRadius,Z=void 0===Q?5:Q,$=e.onMouseOver,ee=e.onMouseOut,te=_.x,re=_.y,ne=f(k),oe=f(E),ie=f(p).defaultStroke,ae=f(O),ue=ae.stroke,le=ae.size,ce=ae.dashArray,se=d(O),me=o(J);i((function(){(J<=0||J>=1)&&(me.current=.95,console.warn("level should be between 0 and 1. Using default level of 0.95"))}),[J])();var fe=i((function(e,r){se((function(n){return t(t({},n),{y:t(t({},n.y),{domain:"min"===e?[r,re.domain()[1]]:[re.domain()[0],r]})})}))}),[se,re]),de=function(e){return te&&te(e.x)},pe=function(e){return re&&re(e.y)},ye=function(e){return re&&re(e.y0)},ge=function(e){return re&&re(e.y1)},he=n((function(){return ne.group||ne.stroke||ne.fill||ne.size||function(e){return"__group"}}),[ne]),ve=n((function(){var e=he?Array.from(new Set(oe.map(he))).map((function(e){return null===e?"[null]":e})):["__group"],t=e.filter((function(e){return oe.filter((function(t){return he(t)===e})).filter((function(e,t,r){return+ne.x(e)!=+ne.x(r[0])||ne.y(e)!==ne.y(r[0])})).length<=2}));return t.length&&console.warn("Excluding "+I+" smoother for groups with not enough (unique) points: "+t.map((function(e){return"'"+e+"'"})).join(", ")),e=e.filter((function(e){return!t.includes(e)}))}),[oe,he,I,ne]),xe=n((function(){return s({domain:he?Array.from(new Set(oe.map(he))):["__group"],range:(null==ue?void 0:ue.scheme)||D})}),[null==ue?void 0:ue.scheme]),ke=s({domain:ve,range:le?null==le?void 0:le.values:[x]}),Ee=s({domain:ve,range:null==ce?void 0:ce.values}),Oe=n((function(){return[]}),[]),Se=n((function(){return w().x((function(e){return+ne.x(e)})).y((function(e){return parseFloat(ne.y(e))}))}),[ne]),_e=i((function(e){var t=Se(e),r=e.map((function(e){return he(e)})).filter((function(e){return e}))[0];Oe.push({group:r,model:{predict:t.predict,x:[[t[0][0],t[1][0]]]}});var n=e.filter((function(e){return![void 0,null,NaN].includes(ne.x(e))&&![void 0,null,NaN].includes(ne.y(e))})).map((function(e){return{x:+ne.x(e),y:ne.y(e)}})),o=n.map((function(e){return e.x})),i=n.map((function(e){return e.y})),a=o.map((function(e){return t.predict(e)})),u=Math.sqrt(A(o.map((function(e,t){return Math.pow(i[t]-a[t],2)})))/(o.length-2)),l=B.inv(1-(1-me.current)/2,o.length-2),c=A(o.map((function(e,t,r){return Math.pow(e-F(r),2)}))),s=[];return o.sort((function(e,t){return e<t?-1:1})).forEach((function(e,n,i){var a=t.predict(e),m=u*Math.sqrt(1/o.length+Math.pow(e-F(i),2)/c),f=l*m,d={x:e,y:a,y0:a-f,y1:a+f,group:r};s.push(d)})),s}),[Se,Oe,ne,he]),be=i((function(e){var t=e.map((function(e){return+ne.x(e)})),r=e.map((function(e){return parseFloat(ne.y(e))})),n=e.map((function(e){return he(e)})).filter((function(e){return e}))[0],o=new b({x:t.filter((function(e,t){return![void 0,null,NaN].includes(e)&&![void 0,null,NaN].includes(r[t])})),y:r.filter((function(e,r){return![void 0,null,NaN].includes(e)&&![void 0,null,NaN].includes(t[r])}))},{span:Y,band:L});Oe.push({group:n,model:o});var i=o.grid([t.length-1>=C?C:t.length-1]),a=o.predict(i),u=[];return i.x.forEach((function(e,t){var r={x:e,y:a.fitted[t],y0:a.fitted[t]-a.halfwidth[t],y1:a.fitted[t]+a.halfwidth[t],group:n};u.push(r)})),u}),[ne,L,C,Y,Oe,he]),we=n((function(){return ve.map((function(e){var t,r=oe.filter((function(t){return he(t)===e}));return"loess"===I?t=be(r):"linear"===I&&(t=_e(r)),t})).flat()}),[oe,ve,he,I,be,_e]);return a((function(){R&&M(we,(function(e){return e.y0}))<re.domain()[0]?fe("min",M(we,(function(e){return e.y0}))):R&&z(we,(function(e){return e.y1}))>re.domain()[1]&&fe("max",z(we,(function(e){return e.y1})))}),[fe,re,we,R]),r.createElement(r.Fragment,null,ve.map((function(e,t){var n=we.filter((function(t){return t.group===e}));return r.createElement("g",{key:"smoother-"+t,style:{pointerEvents:"none"}},R&&r.createElement(l,{data:n,curve:m,x:de,y0:ye,y1:ge,fill:T||("__group"!==e?xe(e):u||ie),fillOpacity:X}),r.createElement(c,{data:n,curve:m,x:de,y:pe,stroke:"__group"!==e?xe(e):u||ie,strokeOpacity:g,strokeWidth:ke(e),strokeDasharray:"__group"!==e&&(null==ce?void 0:ce.values)?Ee(e):h}))})),!P&&r.createElement(r.Fragment,null,r.createElement(W,{data:"loess"===I?we:Oe,method:I,x:de,y:pe,b:function(e){return e.x},models:Oe,markerRadius:Z,strokeOpacity:g,fillOpacity:R?X:0,stroke:u||ie,thisStrokeScale:xe,thisSizeScale:ke,thisDashArrayScale:Ee,size:x}),r.createElement(S,{xScale:te,yScale:re,onMouseOver:$,onMouseOut:ee})))};q.displayName="GeomSmooth";export{q as GeomSmooth};
//# sourceMappingURL=index.esm.js.map
